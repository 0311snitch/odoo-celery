<section class="oe_container">
  <div class="oe_row oe_spaced">
    <h2 class="oe_slogan" style="color:#875A7B;"><b>Celery</b>: Distributed Task Queue</h2>
    <h3 class="oe_slogan">Odoo integration of the Python #1 asynchronous task queue</h3>

    <div class="alert alert-info" style="padding:8px;font-weight:300;font-size:20px;">
      <i class="fa fa-hand-o-right"></i><b> Features: </b>
      <ul class="list-unstyled">
        <li>
	  <i class="fa fa-check-square-o text-primary"></i>
          Put <em>model-methods</em> on the Celery Task Queue.
        </li>
        <li>
          <i class="fa fa-check-square-o text-primary"></i>
          Monitor and manage the Task Queue in Odoo.
        </li>
        <li>
          <i class="fa fa-check-square-o text-primary"></i>
          All Exceptions are catched and available as State=Failure with Exception message/trace shown.
        </li>
        <li>
          <i class="fa fa-check-square-o text-primary"></i>
          Requeue of Failed and Pending (stale) tasks.
        </li>
        <li>
          <i class="fa fa-check-square-o text-primary"></i>
          No complex installation and setup requirements are needed, except the Celery setup.
        </li>
      </ul>
    </div>
    
    <div class="oe_row oe_centeralign mb32">
      <h4>Check out the links below, for more info about <i>Celery</i>.</h4>
      <a href="http://celeryproject.org" target="_blank" class="oe_button oe_big">Celery</a>
      <a href="http://docs.celeryproject.org/en/latest/getting-started/first-steps-with-celery.html" target="_blank" class="oe_button oe_big oe_tacky">Celery Installation</a>
    </div>
</section>

<section class="oe_container">
  <div class="oe_row oe_spaced">
    <h2 class="oe_slogan" style="color:#875A7B;">Put a <em>model-method</em> on the Celery Task Queue</h2>
    <h3 class="oe_slogan">Just Python code to call from an Odoo model</h3>
    <h4>Example</h4>
    <strong>Model and method</strong>
    <ul>
      <li><strong>model</strong>: "celery.example"</li>
      <li><strong>method</strong>: "schedule_import"</li>
    </ul>

    <strong>Optional Celery options (is a kwarg)</strong>
    <pre style="background-color: #dedede;">
celery = {
    'queue': 'high.priority',
    'countdown': 5,
    'retry': True,
    'retry_countdown_setting': 'MULTIPLY_RETRIES',
    'retry_policy': {
        'interval_start': 30
    }
}</pre>
    <strong>Calling the task</strong>
    <pre style="background-color: #dedede;">self.env["celery.task"].call_task("celery.example", "schedule_import", celery=celery)</pre>
    
    <h4>Celery Options</h4>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Option</th>
          <th>Description</th>
          <th>Celery Documentation</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>queue</code></td>
          <td>Name of the Celery/worker queue, the task shall be routed to.</td>
          <td><a href="http://docs.celeryproject.org/en/latest/userguide/routing.html">Routing Tasks</a></td>
        </tr>
        <tr>
          <td><code>countdown</code></td>
          <td>The countdown is a shortcut to set ETA by seconds into the future.</td>
          <td><a href="http://docs.celeryproject.org/en/latest/userguide/calling.html#eta-and-countdown">ETA and Countdown</a></td>
        </tr>
        <tr>
          <td><code>retry</code></td>
          <td>Set to <code>True</code> to enable the retry of sending task messages.</td>
          <td><a href="http://docs.celeryproject.org/en/latest/userguide/calling.html#message-sending-retry">Message Sending Retry</a></td>
        </tr>
        <tr>
          <td><code>retry_countdown_setting</code></td>
          <td>Specify whether and how to increase the retry countdown by:
            <ul>
              <li>Multiply the countdown (option) by number of retry requests</li>
              <li>Add seconds to the <code>countdown</code>.</li>
            </ul>
          </td>
          <td>This is a custom option which affects the Celery <code>countdown</code> option.</td>
        </tr>
        <tr>
          <td><code>retry_countdown_add_seconds</code></td>
          <td>Specify the seonds to add to the retry countdown</td>
          <td>This is a custom option which affects the Celery <code>countdown</code> option.</td>
        </tr>
        <tr>
          <td><code>retry_policy</code></td>
          <td>Options when retrying publishing a task message in the case of connection loss or other connection errors.</td>
          <td><a href="http://docs.celeryproject.org/en/latest/userguide/calling.html#message-sending-retry">Message Sending Retry</a></td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<section class="oe_container oe_dark">
  <div class="oe_row oe_spaced">
    <h2 class="oe_slogan" style="color:#875A7B;">Monitor and control the Celery Task Queue</h2>
    <div class="oe_row_img oe_centered">
      <h4 class="oe_mb16 text-center">List of queued tasks</h4>
      <img class="oe_demo oe_picture oe_screenshot" src="odoo-task-queue-failure.png">
    </div>
    <div class="oe_row_img oe_centered">
      <h4 class="oe_mb16 text-center">Task Failure info</h4>
      <img class="oe_demo oe_picture oe_screenshot" src="odoo-task-failure.png">
    </div>
    <div class="oe_row_img oe_centered">
      <h4 class="oe_mb16 text-center">Tasks waiting for Retry</h4>
      <img class="oe_demo oe_picture oe_screenshot" src="odoo-task-queue-retry.png">
    </div>
    <div class="oe_row_img oe_centered">
      <h4 class="oe_mb16 text-center">Task waiting for Retry with Failure info</h4>
      <img class="oe_demo oe_picture oe_screenshot" src="odoo-task-retry.png">
    </div>
    <div class="oe_row_img oe_centered">
      <h4 class="oe_mb16 text-center">Requeue a Failed Task</h4>
      <img class="oe_demo oe_picture oe_screenshot" src="odoo-requeue-single-task.png">
    </div>
    <div class="oe_row_img oe_centered">
      <h4 class="oe_mb16 text-center">Requeue multiple Failed Tasks</h4>
      <img class="oe_demo oe_picture oe_screenshot" src="odoo-requeue-multiple-tasks.png">
    </div>
  </div>
</section>

<section class="oe_container">
  <div class="oe_row oe_spaced">
    <h2 class="oe_slogan" style="color:#875A7B;">Installation and configuration</h2>
    <div class="oe_row_img oe_centered">
      <h4 class="oe_mb16 text-center">Celery and Message broker</h4>
      <div class="oe_row oe_centeralign mb64">
        <a href="http://docs.celeryproject.org/en/latest/getting-started/first-steps-with-celery.html" target="_blank" class="oe_button oe_big">Celery Installation</a>
      </div>
    </div>
    <div class="oe_row_img oe_centered">
      <h4 class="oe_mb16 text-center">Odoo configuration</h4>
      <p>
        All you need is a few [celery] settings in the Odoo configuration file.
        See: <a href="https://github.com/novacode-nl/odoo-celery/blob/11.0/celery/example.odoo.conf">example.odoo.conf</a>
      </p>
      <p>This enables the Celery process to authenticate in Odoo, by the XML-RPC server.</p>
    </div>
    <div class="oe_row_img oe_centered">
      <h4 class="oe_mb16 text-center">Start the Celery (Odoo) worker server</h4>
      <p>Check the Celery Documentation for more ways to start and manage the server/process.</p>
      <p>The Celery (Odoo) worker => Python file <strong>odoo.py</strong>, which is located directly under the "celery" module directory.</p>
      <p><strong>Start on command line, whereas "odoo" references to the Python file:</strong></p>
      <pre style="background-color: #dedede;"># celery -A odoo worker --loglevel=info</pre>
    </div>
  </div>
</section>

<section class="oe_container oe_dark">
  <div class="oe_row oe_spaced">
    <h2 class="oe_slogan" style="color:#875A7B;">"Celery Example" module</h2>
    <h3 class="oe_slogan">Demo of 2 implemented example tasks, queued by 2 buttons</h3>
    <div class="oe_row oe_centeralign mb16">
      <h4>Check out the "Celery Example" module</h4>
      <ul>
        <li>After installation, go to the menu "Celery / Example Task".</li>
        <li>Click button(s) "Queue create Line" shown in screensshot, which puts a task on the queue.</li>
        <li>Check the queue (menu: Celery / Tasks). Check the form of the Example record - new Lines had been created.</li>
      </ul>
      <a href="https://apps.odoo.com/apps/modules/11.0/celery_example/" target="_blank" class="oe_button oe_big">Celery Example module</a>
      <img class="oe_demo oe_picture oe_screenshot" src="odoo-example-task-list.png">
      <img class="oe_demo oe_picture oe_screenshot" src="odoo-example-task-form.png">
    </div>
  </div>
</section>

<section class="oe_container">
  <div class="oe_row oe_spaced">
    <h2 class="oe_slogan" style="color:#875A7B;">Changelog</h2>
    <h4 class="oe_mb16">0.8</h4>
    <ul>
      <li>Fix: Task retry countdown/interval ignored. For more info see <a href="https://github.com/novacode-nl/odoo-celery/issues/14" target="_blank">GitHub issue</a></li>
      <li>Add task retry countdown settings (multiply by number of retry requests - OR - add seconds).</li>      
      <li>Jammed tasks: (1) Add/show field <code>reference</code> (2) search-view with filters and grouping.</li>
      <li>Task settings: track changes of fields <code>model, method, handle_jammed</code></li>
      <li>Task form-view: disable create/copy</li>
    </ul>
    <h4 class="oe_mb16">0.7</h4>
    <ul>
      <li>Task <em>Reference</em>, which serves:
        <ul>
          <li>Easier searching for tasks by Reference.</li>
          <li>Check (ORM query) before <code>call_task()</code> call, to prevent redundant creation of recurring Pending tasks.</li>
        </ul>
      </li>
    </ul>
    <h4 class="oe_mb16">0.6</h4>
    <em>Introduction of "Jammed" tasks. A jammed task could be caused, for example by: a stopped/restarted Celery worker, message broker, or server.</em>
    <ul>
      <li>Settings: to specify when a task (model, method) is Jammed after seconds from Started or Retry (states).</li>
      <li>Jammed Tasks Report: which shows Jammed (not completed) tasks.</li>
      <li>Cron or manually put tasks in "Jammed" state.</li>
      <li>Ability to cancel (Pending or Jammed) tasks, which never completed.</li>
      <li>Track and messaging about state change. Chatter on form view.</li>
    </ul>
    <h4 class="oe_mb16">0.5</h4>
    <ul>
      <li>Routing tasks to specific (named) queues.</li>
    </ul>
    <h4 class="oe_mb16">0.4</h4>
    <ul>
      <li>FIX: Store task state (Started, Retry) before execution.</li>
    </ul>
    <h4 class="oe_mb16">0.3</h4>
    <ul>
      <li>
        Hide (Odoo) password in payload used by the broker for XML-RPC authentication.
        Mentoined in GitHub issue: <a href="https://github.com/novacode-nl/odoo-celery/issues/4" target="_blank">https://github.com/novacode-nl/odoo-celery/issues/4</a>
      </li>
    </ul>
    <h4 class="oe_mb16">0.2</h4>
    <ul>
      <li>Task state information.</li>
    </ul>
    <h4 class="oe_mb16">0.1</h4>
    <ul>
      <li>Initial version.</li>
    </ul>
  </div>
</section>
